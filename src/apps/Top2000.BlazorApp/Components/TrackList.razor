@using Top2000.BlazorApp.Services
@using Top2000.Features.Listing
@inject TrackService TrackService

@if (_isLoading)
{
    <div class="text-center p-4">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading tracks...</span>
        </div>
        <p class="mt-2">Loading @Year tracks...</p>
    </div>
}
else if (_tracks.Count == 0)
{
    <div class="text-center p-4">
        <p class="text-muted">No tracks found for @Year</p>
    </div>
}
else
{
    <ul class="track-list">
        @foreach (var track in _tracks)
        {
            <li class="@(track.TrackId == SelectedTrack ? "selected" : "")"
                @onclick="() => OnSelect.InvokeAsync(track.TrackId)">
                <h4 style="text-align: left; margin: 0; display: flex; align-items: center;">
                    <span style="min-width: 60px; display: inline-block;">@track.Position</span>
                    <span style="margin-left: 10px;">@track.Title</span>
                </h4>
                <h5 style="text-align: left; margin: 0; display: flex; align-items: center;">
                    <span style="min-width: 60px; display: inline-block;">
                        @switch (track.Delta)
                        {
                            case null:
                                <span title="New" style="color: #28a745; font-weight: bold;"><i class="bi bi-plus-square-fill"></i></span>
                                break;
                            case < 0:
                                <span title="Down" style="color: #dc3545;"><i class="bi bi-chevron-down"></i> @Math.Abs(track.Delta.Value)</span>
                                break;
                            case > 0:
                                <span title="Up" style="color: #28a745;"><i class="bi bi-chevron-up"></i> @track.Delta</span>
                                break;
                            default:
                            {
                                switch (track)
                                {
                                    case { Delta: 0, IsRecurring: true }:
                                        <span title="Recurring" style="color: #6c757d;"><i class="bi bi-arrow-counterclockwise"></i></span>
                                        break;
                                    case { Delta: 0, IsRecurring: false }:
                                        <span title="No change" style="color: #adb5bd;"><i class="bi bi-dash"></i></span>
                                        break;
                                }

                                break;
                            }
                        }
                    </span>
                    <span style="margin-left: 10px;">@track.Artist</span>
                </h5>
            </li>
        }
    </ul>
}

@code {
    [Parameter] public int Year { get; set; }
    [Parameter] public int? SelectedTrack { get; set; }
    [Parameter] public EventCallback<int> OnSelect { get; set; }

    List<TrackListing> _tracks = [];
    bool _isLoading = false;

    protected override void OnParametersSet()
    {
        _isLoading = true;
        try
        {
            _tracks = TrackService.ByEdition(Year);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }
}